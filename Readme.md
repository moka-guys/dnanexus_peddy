# dnanexus_peddy v 1.0.0

## What does this app do?
This app runs peddy (https://github.com/brentp/peddy) to perform a run wide QC checking that the assigned gender matches the sample and that the run does not contain duplicate samples. It uses the sample metadata contained within the samples filenames plus the vcf files created by the pipeline.  

This app uses a release of peddy from https://github.com/moka-guys/peddy

## What are typical use cases for this app?
The app is designed to be executed after the DNA Nexus workflows for all samples in a run have sucessfuly completed.
The peddy output files are processed by multiqc >v1.3, which displays peddy data in the resulting report. This app is scheduled to run by the DNA Nexus upload agent script using the --depends-on flag.

Peddy detects when the expected sex of a sample does not match the sex inferred from the sequence data. This works by measuring the ratio of heterozygous to homozygous genotypes in the X chromosome; As males have one X chromosome, they should have zero true heterozygous calls in the X chromosome, whereas females should have a mixture. This is reported via the  **sex/het ratio**, which is the count of heterozygous calls divided by the count of homozygous alternate calls. The sex/het ratio is **low for males, high for females**.

## What data are required for this app to run?
- A project number is passed to the app as a parameter.
- The given project must have an 'output' folder containing VCFs to be processed by peddy. Each vcf must have the extension '.refined.vcf.gz'.
- The filename of each sample must include the gender as 'M' or 'F' deliminated by underscores.

## What does this app output?
All output files produced are prefixed with 'ped'. MultiQC requires 4 files:
1. ped.peddy.ped
2. ped.het_check.csv
3. ped.ped_check.csv
4. ped.sex_check.csv

These files are output to the directory '/QC/'. Files in this directory are included in the final MultiQC report generated by the dnanexus_multiqc app. The remaining peddy output files are placed in the subfolder '/QC/peddy'.

## How does this app work?
This app performs the following procedure:
* Parse the file names to determine the expected sex for each sample and create a [fam file](https://www.cog-genomics.org/plink2/formats#fam) containing this information.
* Download and merge the VCFs in the project's '/output/' folder.
* Run peddy, passing the merged VCF and fam file as arguments.
* Upload outputs to the directories '/QC/' and '/QC/peddy' in the DNA Nexus project.

## What are the limitations of this app
The project which peddy is run on must be shared with the user mokaguys.

## This app was made by Viapath Genome Informatics